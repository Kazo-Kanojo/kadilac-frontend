<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ficha de Veículo</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="recibo-a4 ficha-veiculo">
        <header class="doc-header">
            <h1 style="text-transform: uppercase;">{{LOJA_RAZAO}}</h1>
            <p class="separador">***</p>
            <h2>FICHA DE VEÍCULO</h2>
            <p class="separador">***</p>
        </header>

        <div class="datas-entrada-saida">
            <p><strong>Dt. Entrada:</strong> {{DATA_ENTRADA}}</p>
            <p><strong>Dt. Saída:</strong> {{DATA_SAIDA}}</p>
        </div>

        <main>
            <section class="info-principal-veiculo">
                <div class="field-group" style="flex-basis: 100%;">
                    <div class="field" style="flex-basis: 55%;"><label>Veículo:</label><span>{{VEICULO_MODELO}}</span></div>
                    <div class="field" style="flex-basis: 40%;"><label>Placa:</label><span>{{VEICULO_PLACA}}</span></div>
                    
                    <div class="field" style="flex-basis: 30%;"><label>Ano:</label><span>{{VEICULO_ANO}}</span></div>
                    <div class="field" style="flex-basis: 30%;"><label>Cor:</label><span>{{VEICULO_COR}}</span></div>
                    <div class="field" style="flex-basis: 35%;"><label>Combustível:</label><span>{{VEICULO_COMBUSTIVEL}}</span></div>
                    
                    <div class="field" style="flex-basis: 45%;"><label>Renavam:</label><span>{{VEICULO_RENAVAM}}</span></div>
                    <div class="field" style="flex-basis: 50%;"><label>Chassi:</label><span>{{VEICULO_CHASSI}}</span></div>
                </div>
            </section>

            <div class="partes-container">
                
                <div class="parte-bloco">
                    <h3>ORIGEM / PROPRIETÁRIO ANT.</h3>
                    <div class="field full"><label>Nome:</label><span>{{ANTIGO_NOME}}</span></div>
                    <div class="field full"><label>Tel:</label><span>{{ANTIGO_TEL}}</span></div>
                    <div class="field full"><label>Cidade:</label><span>{{ANTIGO_CIDADE}}</span></div>
                </div>

                <div class="parte-bloco">
                    <h3>DESTINO / COMPRADOR</h3>
                    <div class="field full"><label>Nome:</label><span>{{CLIENTE_NOME}}</span></div>
                    <div class="field full"><label>CPF:</label><span>{{CLIENTE_CPF}}</span></div>
                    <div class="field full"><label>Tel:</label><span>{{CLIENTE_TEL}}</span></div>
                    <div class="field full"><label>Endereço:</label><span>{{CLIENTE_ENDERECO}}</span></div>
                </div>

                <div class="parte-bloco">
                    <h3>VEÍCULO NA TROCA</h3>
                    <div class="field full"><label>Veículo:</label><span>{{TROCA_VEICULO}}</span></div>
                    <div class="field full"><label>Placa:</label><span>{{TROCA_PLACA}}</span></div>
                    <div class="field full"><label>Valor:</label><span>{{TROCA_VALOR}}</span></div>
                </div>
            </div>

            <h3 style="margin-bottom: 5px;">RELATÓRIO DE CUSTOS & DESPESAS</h3>
            <table class="despesas-tabela">
                <thead>
                    <tr>
                        <th style="width: 15%;">Data</th>
                        <th style="width: 65%;">Descrição do Serviço / Peça</th>
                        <th style="width: 20%;">Valor</th>
                    </tr>
                </thead>
                <tbody id="lista-despesas">
                    </tbody>
            </table>
            
            <section class="resumo-financeiro">
                <h3>Resumo Financeiro da Operação</h3>
                
                <div class="resumo-linha">
                    <span>Valor de Compra (Custo Veículo):</span>
                    <strong style="color: #d32f2f;">{{VALOR_COMPRA}}</strong>
                </div>
                 <div class="resumo-linha">
                    <span>Total de Despesas (Manutenção):</span>
                    <strong style="color: #d32f2f;">{{TOTAL_DESPESAS}}</strong>
                </div>
                <hr style="border: 1px dashed #000; width: 100%;">
                 <div class="resumo-linha">
                    <span>CUSTO TOTAL (Veículo + Despesas):</span>
                    <strong>{{CUSTO_TOTAL_FINAL}}</strong>
                </div>
                
                <br>
                
                <div class="resumo-linha">
                    <span>Valor de Venda (Negociado):</span>
                    <strong style="color: #1976d2;">{{VALOR_VENDA}}</strong>
                </div>
                
                <hr style="border: 2px solid #000; width: 100%;">
                
                <div class="resumo-linha" style="margin-top: 10px; font-size: 14pt;">
                    <span>LUCRO LÍQUIDO:</span>
                    <strong id="label-lucro">{{LUCRO_FINAL}}</strong>
                </div>
            </section>

            <p class="data-local" style="margin-top: 30px; text-align: center;">{{LOJA_CIDADE}}, {{DATA_ATUAL}}.</p>

        </main>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const data = JSON.parse(localStorage.getItem('sistema_print_data'));
            if (!data) return;

            const fMoney = (val) => val ? parseFloat(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const fDate = (d) => d ? new Date(d).toLocaleDateString('pt-BR') : '-';

            // --- CÁLCULOS FINANCEIROS ---
            const precoCompra = parseFloat(data.vehicle.preco_compra || data.vehicle.custo || 0);
            const precoVenda = parseFloat(data.vehicle.preco_venda || data.vehicle.valor || 0);
            
            // Pega despesas (se tiverem sido passadas, senão vazio)
            const despesas = data.expenses || [];
            const totalDespesas = despesas.reduce((acc, d) => acc + (parseFloat(d.valor) || 0), 0);
            
            const custoTotal = precoCompra + totalDespesas;
            const lucro = precoVenda - custoTotal;

            // --- PREENCHIMENTO DA TABELA DE DESPESAS ---
            const tbody = document.getElementById('lista-despesas');
            if(despesas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Nenhuma despesa lançada.</td></tr>';
            } else {
                let htmlRows = '';
                despesas.forEach(d => {
                    htmlRows += `
                        <tr>
                            <td>${fDate(d.data_despesa)}</td>
                            <td>${d.descricao}</td>
                            <td>${fMoney(d.valor)}</td>
                        </tr>
                    `;
                });
                tbody.innerHTML = htmlRows;
            }

            // --- MAPA DE SUBSTITUIÇÃO ---
            const replacements = {
                '{{LOJA_RAZAO}}': data.store?.razao_social || 'CONCESSIONÁRIA',
                '{{LOJA_CIDADE}}': data.store?.cidade || 'São Paulo',
                
                '{{DATA_ENTRADA}}': fDate(data.vehicle.data_entrada),
                '{{DATA_SAIDA}}': data.vehicle.status === 'Vendido' ? fDate(data.vehicle.data_venda) : 'Em Estoque',
                '{{DATA_ATUAL}}': new Date().toLocaleDateString('pt-BR'),

                // Adicionado a marca junto ao modelo
                '{{VEICULO_MODELO}}': `${data.vehicle.marca || ''} ${data.vehicle.modelo || ''}`.trim(),
                '{{VEICULO_PLACA}}': data.vehicle.placa || '-',
                '{{VEICULO_ANO}}': data.vehicle.ano || '-',
                '{{VEICULO_COR}}': data.vehicle.cor || '-',
                '{{VEICULO_COMBUSTIVEL}}': data.vehicle.combustivel || '-',
                '{{VEICULO_RENAVAM}}': data.vehicle.renavam || '-',
                '{{VEICULO_CHASSI}}': data.vehicle.chassi || '-',

                // Proprietário Anterior (Origem)
                '{{ANTIGO_NOME}}': data.vehicle.proprietario_anterior || 'Não informado',
                '{{ANTIGO_TEL}}': data.prevOwner?.telefone || '-',
                '{{ANTIGO_CIDADE}}': data.prevOwner?.cidade || '-',
                
                // Validação: Só exibe os dados do cliente se o veículo já estiver vendido
                // Validação: Só exibe os dados do cliente se o veículo já estiver vendido
                '{{CLIENTE_NOME}}': data.vehicle.status === 'Vendido' ? (data.client?.nome || data.vehicle.cliente_nome || '-') : '-',
                '{{CLIENTE_CPF}}': data.vehicle.status === 'Vendido' ? (data.client?.cpf_cnpj || '-') : '-',
                '{{CLIENTE_TEL}}': data.vehicle.status === 'Vendido' ? (data.client?.telefone || '-') : '-',

                // Dados do veículo na troca
                '{{TROCA_VEICULO}}': data.vehicle.veiculo_troca || '-',
                '{{TROCA_PLACA}}': data.vehicle.placa_troca || '-',
                '{{TROCA_VALOR}}': data.vehicle.valor_troca ? fMoney(data.vehicle.valor_troca) : '-',
                // Endereço completo formatado (Rua, Número - Bairro - Cidade)
                '{{CLIENTE_ENDERECO}}': data.vehicle.status === 'Vendido' && data.client?.endereco 
                                        ? `${data.client.endereco}${data.client.numero ? ', ' + data.client.numero : ''}${data.client.bairro ? ' - ' + data.client.bairro : ''}${data.client.cidade ? ' - ' + data.client.cidade : ''}` 
                                        : '-',
                    

                // Financeiro
                '{{VALOR_COMPRA}}': fMoney(precoCompra),
                '{{TOTAL_DESPESAS}}': fMoney(totalDespesas),
                '{{CUSTO_TOTAL_FINAL}}': fMoney(custoTotal),
                '{{VALOR_VENDA}}': fMoney(precoVenda),
                '{{LUCRO_FINAL}}': fMoney(lucro)
            };

            // Aplica as substituições no HTML
            let html = document.body.innerHTML;
            for (const [key, val] of Object.entries(replacements)) {
                // Regex global para substituir todas as ocorrências
                html = html.replace(new RegExp(key, 'g'), val);
            }
            document.body.innerHTML = html;

            // Muda cor do lucro (Vermelho se prejuízo, Verde/Azul se lucro)
            const elLucro = document.getElementById('label-lucro');
            if(elLucro) {
                elLucro.style.color = lucro >= 0 ? 'green' : 'red';
            }

            // Imprime automaticamente
            setTimeout(() => window.print(), 800);
        });
    </script>
</body>
</html>